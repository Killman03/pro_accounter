# Миграция: Удаление поля payment_date

## Описание изменений

После изменения логики напоминаний, где дата следующего платежа теперь рассчитывается от последнего платежа клиента (а не от даты начала сделки), поле `payment_date` в таблице `coffee_machines` стало избыточным.

## Что изменилось

### Удалено:
- Поле `payment_date` из модели `CoffeeMachineORM`
- Поле `payment_date` из Pydantic схемы `CoffeeMachine`
- Функция `update_machine_payment_date()` из `db.py`
- Состояние `payment_date` из FSM добавления машины
- Запрос даты следующего платежа при добавлении машины
- Обновление `payment_date` при внесении арендных платежей

### Обновлено:
- Логика напоминаний теперь использует `get_last_payment_date()`
- Функция `send_summary()` теперь рассчитывает просрочки динамически
- Упрощен процесс добавления новой машины

## Выполнение миграции

### 1. Остановите бота
```bash
# Остановите процесс бота
```

### 2. Выполните SQL-миграцию
```sql
-- Выполните в вашей базе данных PostgreSQL:
ALTER TABLE coffee_machines DROP COLUMN IF EXISTS payment_date;
```

### 3. Перезапустите бота
```bash
python bot.py
```

## Преимущества новой системы

1. **Точность**: Дата следующего платежа всегда актуальна
2. **Гибкость**: Не нужно вручную обновлять даты
3. **Простота**: Меньше полей в базе данных
4. **Надежность**: Нет расхождений между реальными платежами и датами

## Проверка после миграции

1. Добавьте новую машину - процесс должен быть короче
2. Внесите платеж - напоминания должны работать корректно
3. Проверьте отчеты - просрочки должны рассчитываться правильно

## Откат (если потребуется)

Если нужно вернуть старую систему:

```sql
-- Добавить поле обратно
ALTER TABLE coffee_machines ADD COLUMN payment_date DATE;

-- Восстановить код из git истории
```

## Примечания

- Поле `payment_date` в таблице `payments` остается без изменений
- Это поле хранит даты фактических платежей и используется в отчетах
- Все существующие данные о платежах сохраняются 